
Summary: Config files for kde
Name:    kde-settings
Version: @VERSION@
Release: @REL@%{?dist}
Epoch:   2000

License: MIT
Url:     https://github.com/FedoraKDE/kde-settings
Source0: https://github.com/FedoraKDE/kde-settings/archive/%{version}/%{name}-%{version}.tar.gz
Source1: COPYING
Source2: kickoff.tar.gz
Source100: 10-qubes.js
Source101: qubes-systray.js
BuildArch: noarch

BuildRequires: kde-filesystem
BuildRequires: systemd

# when kdebugrc was moved here
Conflicts: kf5-kdelibs4support < 5.7.0-3

Obsoletes: kde-settings-ksplash < 24-2
Obsoletes: kde-settings-minimal < 24-3

Requires: kde-filesystem
# /etc/pam.d/ ownership
Requires: pam
Requires: xdg-user-dirs
## add breeze deps here? probably, need more too -- rex
Requires: breeze-icon-theme
#if 0%{?fedora}
# for 11-fedora-kde-policy.rules
#Requires: polkit-js-engine
#endif
Requires: qubes-artwork

Requires(post): coreutils sed

# Qubes Patches:
Patch0: 0001-qubes-menus-prefix.patch
Patch1: 0002-disable-nepomuk.patch
Patch2: 0003-hide-knetattach.patch
Patch3: 0004-disable-klipper.patch
Patch4: 0005-hide-kde-help.patch
Patch5: 0006-hide-thunar.patch
Patch6: 0007-start-here-icon.patch

%description
%{summary}.

## FIXME
%package minimal
Summary: Minimal configuration files for KDE
Requires: %{name} = %{epoch}:%{version}-%{release}
Requires: xorg-x11-xinit
%description minimal
%{summary}.

%package plasma
Summary: Configuration files for plasma
Requires: %{name} = %{epoch}:%{version}-%{release}
Requires: system-logos
%description plasma
%{summary}.

# FIXME/TODO: can probably consider dropping this subpkg now that we
# have good comps and soft dependencies support -- rex
%package pulseaudio
Summary: Enable pulseaudio support in KDE
# nothing here to license
License: Public Domain
Requires: %{name} = %{epoch}:%{version}-%{release}
Requires: pulseaudio
Requires: pulseaudio-module-x11
## kde3
Requires: alsa-plugins-pulseaudio
## kde4: -pulseaudio plugins are installed for all phonon backends by default
%description pulseaudio
%{summary}.

%package -n qt-settings
Summary: Configuration files for Qt
# qt-graphicssystem.* scripts use lspci
#Requires: pciutils
%description -n qt-settings
%{summary}.


%prep
%autosetup -N -n %{name}-%{version}

# omit crud
rm -fv Makefile

tar xf %{SOURCE2}
mkdir -p .%{_datadir}/kde-settings/kde-profile/default/share/plasma/plasmoids
mv kickoff/package .%{_datadir}/kde-settings/kde-profile/default/share/plasma/plasmoids/org.kde.plasma.kickoff
rm -rf kickoff

%autopatch -p1

%install
mkdir -p %{buildroot}{%{_datadir}/config,%{_sysconfdir}/kde/kdm}

tar cpf - . | tar --directory %{buildroot} -xvpf -

cp -p %{SOURCE1} .

# omit kdm stuff
rm -rfv %{buildroot}%{_sysconfdir}/{kde/kdm,logrotate.d/kdm,pam.d/kdm*}
rm -fv %{buildroot}%{_localstatedir}/lib/kdm/backgroundrc
rm -fv %{buildroot}%{_tmpfilesdir}/kdm.conf
rm -fv %{buildroot}%{_unitdir}/kdm.service

## unpackaged files
# formerly known as -minimal
rm -fv %{buildroot}%{_sysconfdir}/X11/xinit/xinitrc.d/20-kdedirs-minimal.sh
rm -fv %{buildroot}%{_sysconfdir}/profile.d/qt-graphicssystem.*

# FIXME/NEEDSWORK, still (mostly?) kde4
# rhel stuff
%if 0%{?rhel} && 0%{?rhel} <= 7
rm -rf %{buildroot}%{_sysconfdir}/kde/env/fedora-bookmarks.sh \
       %{buildroot}%{_prefix}/lib/rpm \
       %{buildroot}%{_datadir}/polkit-1/
echo "[Theme]" > %{buildroot}%{_datadir}/kde-settings/kde-profile/default/share/config/plasmarc
echo "name=RHEL7" >> %{buildroot}%{_datadir}/kde-settings/kde-profile/default/share/config/plasmarc
echo "[KSplash]" > %{buildroot}%{_datadir}/kde-settings/kde-profile/default/share/config/ksplashrc
echo "Theme=RHEL7" >> %{buildroot}%{_datadir}/kde-settings/kde-profile/default/share/config/ksplashrc
perl -pi -e "s,^Theme=.*,Theme=/usr/share/kde4/apps/kdm/themes/RHEL7," %{buildroot}%{_sysconfdir}/kde/kdm/kdmrc
perl -pi -e "s,^HomeURL=.*,HomeURL=file:///usr/share/doc/HTML/index.html," %{buildroot}%{_datadir}/kde-settings/kde-profile/default/share/config/konquerorrc
perl -pi -e "s,^View0_URL=.*,View0_URL=file:///usr/share/doc/HTML/index.html," %{buildroot}%{_datadir}/kde-settings/kde-profile/default/share/apps/konqueror/profiles/webbrowsing
%endif

# Remove Fedora branding
rm -f %{buildroot}%{_datadir}/plasma/shells/org.kde.plasma.desktop/contents/updates/00-start-here-2.js
rm -f %{buildroot}%{_datadir}/kde-settings/kde-profile/default/share/config/plasmarc
rm -f %{buildroot}%{_datadir}/kde-settings/kde-profile/default/share/config/ksplashrc

# Qubes defaults
install -m 644 %{SOURCE100} %{buildroot}%{_datadir}/plasma/shells/org.kde.plasma.desktop/contents/updates/
install -m 644 %{SOURCE101} %{buildroot}%{_datadir}/plasma/shells/org.kde.plasma.desktop/contents/updates/

%check
%if 0%{?version_maj:1}
test -f %{_datadir}/wallpapers/F%{version_maj} || ls -l %{_datadir}/wallpapers
%endif


%files
%license COPYING
%config(noreplace) %{_sysconfdir}/profile.d/kde.*
%{_sysconfdir}/kde/env/env.sh
%{_sysconfdir}/kde/env/gpg-agent-startup.sh
%{_sysconfdir}/kde/shutdown/gpg-agent-shutdown.sh
%{_sysconfdir}/kde/env/gtk2_rc_files.sh
%if 0%{?fedora} || 0%{?rhel} > 7
%{_sysconfdir}/kde/env/fedora-bookmarks.sh
%{_datadir}/kde-settings/
# these can probably go now -- rex
%{_prefix}/lib/rpm/plasma4.prov
%{_prefix}/lib/rpm/plasma4.req
%{_prefix}/lib/rpm/fileattrs/plasma4.attr
%{_datadir}/polkit-1/rules.d/11-fedora-kde-policy.rules
%endif
%config(noreplace) %{_sysconfdir}/xdg/kcm-about-distrorc
%config(noreplace) %{_sysconfdir}/xdg/kdebugrc
%config(noreplace) %{_sysconfdir}/pam.d/kcheckpass
%config(noreplace) %{_sysconfdir}/pam.d/kscreensaver
# drop noreplace, so we can be sure to get the new kiosk bits
%config %{_sysconfdir}/kderc
%config %{_sysconfdir}/kde4rc
%dir %{_datadir}/kde-settings/
%dir %{_datadir}/kde-settings/kde-profile/
%{_datadir}/applications/kde-mimeapps.list
%if 0%{?rhel} && 0%{?rhel} <= 7
%exclude %{_datadir}/kde-settings/kde-profile/default/share/apps/plasma-desktop/init/00-defaultLayout.js
%endif

%files plasma
%{_datadir}/plasma/shells/org.kde.plasma.desktop/contents/updates/10-qubes.js
%{_datadir}/plasma/shells/org.kde.plasma.desktop/contents/updates/qubes-systray.js
%{_sysconfdir}/xdg/plasma-workspace/env/env.sh
%{_sysconfdir}/xdg/plasma-workspace/env/gtk2_rc_files.sh
%{_sysconfdir}/xdg/plasma-workspace/env/gtk3_scrolling.sh
%{_sysconfdir}/xdg/plasma-workspace/shutdown/kuiserver5.sh
%{_datadir}/plasma/look-and-feel/org.fedoraproject.fedora.desktop/contents/plasmoidsetupscripts/org.kde.plasma.kicker.js
%{_datadir}/plasma/look-and-feel/org.fedoraproject.fedora.desktop/contents/plasmoidsetupscripts/org.kde.plasma.kickerdash.js
%{_datadir}/plasma/look-and-feel/org.fedoraproject.fedora.desktop/contents/plasmoidsetupscripts/org.kde.plasma.kickoff.js
%if 0%{?version_maj:1}
%endif

%files pulseaudio
# nothing, this is a metapackage

%files -n qt-settings
%license COPYING
%config(noreplace) %{_sysconfdir}/Trolltech.conf
#config(noreplace) %{_sysconfdir}/profile.d/qt-graphicssystem.*


%changelog
@CHANGELOG@
